<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>{% if selection_id or offer %}Flight Booking{% else %}Booking Saya{% endif %}</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    :root {
      --space-1: 4px; --space-2: 8px; --space-3: 12px; --space-4: 16px; --space-5: 24px; --space-6: 32px; --space-7: 48px; --space-8: 64px;
      --gutter: var(--space-4);
      --shadow-1: 0 2px 8px rgba(0,0,0,0.10); --shadow-2: 0 6px 20px rgba(0,0,0,0.12);
      --surface: #ffffff; --surface-muted: #f3f4f6; --text: #111827; --muted: #6b7280; --border: #e5e7eb;
      --primary: #2563eb; --primary-hover: #1d4ed8;
      --radius-1: 8px; --radius-2: 12px; --radius-3: 16px; --radius-4: 24px;
      --container-max: 1200px;
      --bp-sm: 480px; --bp-md: 768px; --bp-lg: 1024px; --bp-xl: 1280px;
    }

    * { box-sizing: border-box; }
    html { color-scheme: light; }
    body { margin: 0; font-family: 'Poppins', Arial, sans-serif; color: var(--text); background: #0b1220; }
    a { color: var(--primary); text-decoration: none; }
    a:hover { color: var(--primary-hover); }
    :focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }

    .container { width: min(var(--container-max), 100% - var(--space-6)); margin-inline: auto; padding-inline: var(--space-4); }

    /* From bookings.html: Header/Nav */
    header.site-header { position: relative; z-index: 2; padding: var(--space-3) 0; }
    .header-bar { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: var(--space-3); }
    .nav-pill { display: inline-flex; align-items: center; gap: var(--space-3); background: var(--surface); border-radius: 999px; padding: var(--space-2) var(--space-3); box-shadow: var(--shadow-1); }
    .nav-link { color: var(--text); font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
    .divider { width: 1px; height: 20px; background: var(--border); }
    .actions { display: inline-flex; align-items: center; gap: var(--space-2); }
    .btn { display: inline-flex; align-items: center; justify-content: center; height: 40px; padding: 0 var(--space-4); border-radius: var(--radius-2); font-weight: 600; border: 1px solid transparent; color: var(--text); background: transparent; transition: background-color .3s ease, color .3s ease, border-color .3s ease, box-shadow .3s ease; }
    .btn-primary { background: var(--primary); color: #fff; transition: background-color .3s ease, box-shadow .3s ease, color .3s ease; }
    .btn-primary:hover { background: var(--primary-hover); color: #fff; box-shadow: var(--shadow-2); }

    /* Shared layout */
    main.content { padding: var(--space-8) 0 var(--space-8); }
    .page-header { display: flex; justify-content: space-between; align-items: end; margin-top: var(--space-6); margin-bottom: var(--space-5); }
    .title { font-size: 28px; font-weight: 700; letter-spacing: -0.02em; margin: 0; color: #f8fafc; }
    .subtitle { color: #cbd5e1; margin-top: var(--space-1); }

    /* From bookings.html: Card/List */
    .booking-list { display: grid; grid-template-columns: 1fr; gap: var(--space-4); }
    @media (min-width: 768px) { .booking-list { grid-template-columns: 1fr 1fr; } }
    @media (min-width: 1024px) { .page-header { margin-top: var(--space-7); } }
    .booking-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-2); box-shadow: var(--shadow-1); padding: var(--space-4); display: grid; gap: var(--space-3); transition: box-shadow .2s ease, transform .2s ease; }
    .booking-card:hover { box-shadow: var(--shadow-2); transform: translateY(-2px); }
    .header-row { display: flex; justify-content: space-between; align-items: center; }
    .ref { font-weight: 600; }
    .status { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); background: #f8fafc; color: #0f172a; }
    .status.confirmed { background: #dcfce7; border-color: #86efac; color: #166534; }
    .route { font-size: 16px; font-weight: 600; }
    .meta { color: var(--muted); font-size: 13px; }
    .price { font-weight: 700; }
    .card-actions { display: flex; gap: var(--space-2); justify-content: flex-end; }
    .card-btn { height: 36px; padding: 0 var(--space-3); border-radius: var(--radius-2); border: 1px solid var(--border); background: var(--surface); color: var(--text); cursor: pointer; transition: background-color .2s ease, border-color .2s ease, box-shadow .2s ease; }
    .card-btn:hover { background: #f9fbff; box-shadow: var(--shadow-1); }
    .card-btn.primary { background: var(--primary); border-color: var(--primary); color: #fff; }
    .card-btn.primary:hover { background: var(--primary-hover); }

    /* Button set (aligned with search.html) */
    .sb-button { height: 44px; padding: 0 22px; background: var(--primary); color: #fff; border: none; border-radius: var(--radius-3); font-weight: 600; cursor: pointer; min-width: 180px; display: inline-flex; align-items: center; justify-content: center; transition: background-color .3s ease, box-shadow .3s ease, color .3s ease; }
    .sb-button:hover { background: var(--primary-hover); color: #fff; box-shadow: var(--shadow-2); }
    .sb-button:active, .btn-primary:active { transform: scale(0.98); }
    .sb-button-2 { height: 44px; padding: 0 22px; background: var(--primary); color: #fff; border: none; border-radius: var(--radius-3); font-weight: 600; cursor: pointer; min-width: 180px; display: inline-flex; align-items: center; justify-content: center; transition: background-color .2s ease; }
    .sb-button-2:hover { background: var(--primary-hover); }
    .sb-button-2.manage { height: 48px; min-width: 200px; gap: 10px; }
    .receipt-details { display: block; overflow: hidden; max-height: 0; opacity: 0; transition: max-height .3s ease, opacity .3s ease; border: 1px solid var(--border); border-radius: var(--radius-2); padding: 0 var(--space-4); margin-top: var(--space-3); background: var(--surface); }
    .receipt-details.open { max-height: 800px; opacity: 1; padding: var(--space-4); }
    .receipt-grid { display: grid; grid-template-columns: 1fr; gap: var(--space-4); }
    @media (min-width: 768px) { .receipt-grid { grid-template-columns: 1fr 1fr; } }

    /* From booking.html: Form controls */
    .form { display: grid; gap: var(--space-2); }
    label { display: block; font-weight: 600; margin-top: var(--space-2); color: #cbd5e1; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="date"] {
      padding: 10px; border: 1px solid var(--border); border-radius: var(--radius-2); width: 100%; max-width: 420px;
    }
    select { padding: 10px; border: 1px solid var(--border); border-radius: var(--radius-2); width: 100%; max-width: 420px; background: var(--surface); color: var(--text); }

    .form-grid { display: grid; grid-template-columns: 1fr; gap: var(--space-4); margin-top: var(--space-2); }
    .col { display: grid; gap: var(--space-2); }
    @media (min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr; } }
  
    @media (prefers-reduced-motion: reduce) { * { transition: none !important; animation: none !important; } }
  </style>
</head>
<body>
  {% include 'flight/header.html' %}

  <main class="content" role="main">
    <div class="container">
      {% if confirmation %}
        <article class="booking-card" aria-label="Konfirmasi Pembayaran" role="alert">
          <div class="header-row">
            <div class="ref">Pembayaran berhasil • Ref: {{ confirmation.ref }}</div>
            <div class="status confirmed" aria-label="Status">Confirmed</div>
          </div>
          <div class="route">{{ confirmation.origin }} → {{ confirmation.destination }} <span class="meta">({{ confirmation.airline }} {{ confirmation.flight_number }})</span></div>
          <div class="meta">{{ confirmation.departure_time }} - {{ confirmation.arrival_time }}</div>
          <div class="price">Total: {{ confirmation.amount }} {{ confirmation.currency }}{% if confirmation.amount_idr %} • Rp {{ confirmation.amount_idr }}{% endif %}</div>
          <div class="card-actions">
            <button class="sb-button-2" type="button" onclick="window.print()">Cetak Konfirmasi</button>
          </div>
        </article>
      {% endif %}
      {% if error %}
        <div class="error" role="alert">{{ error }}</div>
      {% endif %}
      {% if selection_id or offer %}
        <!-- From booking.html: Booking Confirmation -->
        <div class="page-header">
          <div>
            <h1 class="title">Flight Booking</h1>
            {% if origin_label or destination_label %}
              <p class="subtitle"><strong>Penerbangan:</strong> {{ origin_label }} → {{ destination_label }}</p>
            {% else %}
              <p class="subtitle">Lengkapi data penumpang untuk konfirmasi</p>
            {% endif %}
          </div>
          <div class="card-actions">
            <a href="{% url 'search_flights' %}" class="sb-button">Cari Penerbangan</a>
          </div>
        </div>

        {% if offer %}
          <article class="booking-card" aria-label="Detail Penawaran">
            <!-- From booking.html: Offer Details -->
            <div>Offer ID: {{ offer.id }}</div>
            {% if offer.price %}
              <div><strong>Harga:</strong> {{ offer.price.total }} {{ offer.price.currency }}</div>
              {% if offer_idr_str %}
                <div><strong>Harga (IDR):</strong> Rp {{ offer_idr_str }}</div>
              {% endif %}
            {% endif %}
            {% if offer.itineraries %}
              {% for itin in offer.itineraries %}
                <div>
                  {% for segment in itin.segments %}
                    <div>
                      {{ segment.departure.iataCode }} → {{ segment.arrival.iataCode }}
                      ({{ segment.carrierCode }} {{ segment.number }})
                      {{ segment.departure.at }} - {{ segment.arrival.at }}
                    </div>
                  {% endfor %}
                </div>
              {% endfor %}
            {% endif %}
          </article>
        {% else %}
          <article class="booking-card">
            <div>Tidak ada penawaran yang dipilih.</div>
          </article>
        {% endif %}

        <!-- From booking.html: Passenger Form -->
        <form id="booking_form" class="form" method="post" action="{% url 'confirm_booking' %}">
          {% csrf_token %}
          <input type="hidden" name="idx" value="{{ idx }}" />
          <input type="hidden" name="selection_id" value="{{ selection_id }}" />
          <div class="form-grid" aria-label="Formulir Penumpang">
            <div class="col" aria-label="Kolom kiri">
              <label for="name">Nama Lengkap</label>
              <input id="name" type="text" name="name" required aria-required="true" class="input" />
              <label for="passport">Nomor Paspor</label>
              <input id="passport" type="text" name="passport" required aria-required="true" class="input" />
              <label for="nationality">Nationality</label>
              <select id="nationality" name="nationality" required aria-required="true">
                <option value="">Pilih negara</option>
                <option value="ID">Indonesia</option>
                <option value="MY">Malaysia</option>
                <option value="SG">Singapore</option>
                <option value="TH">Thailand</option>
                <option value="JP">Japan</option>
                <option value="AU">Australia</option>
                <option value="US">United States</option>
                <option value="GB">United Kingdom</option>
              </select>
              <label for="birth_date">Tanggal Lahir</label>
              <input id="birth_date" type="date" name="birth_date" required aria-required="true" class="input" placeholder="mm/dd/yyyy" />
            </div>
            <div class="col" aria-label="Kolom kanan">
              <label for="passport_expiry">Masa Berlaku Paspor</label>
              <input id="passport_expiry" type="date" name="passport_expiry" required aria-required="true" class="input" placeholder="mm/dd/yyyy" />
              <label for="email">Email</label>
              <input id="email" type="email" name="email" required aria-required="true" class="input" />
              <label for="phone">No. HP</label>
              <input id="phone" type="tel" name="phone" required aria-required="true" class="input" inputmode="numeric" />
            </div>
          </div>
          <div class="card-actions" style="margin-top: var(--space-3);">
            <button type="submit" class="sb-button">Konfirmasi Booking</button>
            <a href="{% url 'flight_results' %}" class="btn">Kembali ke Flight Results</a>
          </div>
        </form>
      {% else %}
        <!-- From bookings.html: My Bookings List -->
        <div class="page-header">
          <div>
            <h1 class="title">Booking Saya</h1>
            <p class="subtitle">Ringkasan penerbangan yang telah Anda pesan</p>
          </div>
          <div class="card-actions">
            <a href="{% url 'search_flights' %}" class="sb-button">Cari Penerbangan</a>
          </div>
        </div>

        {% if items and items|length %}
          <section class="booking-list" aria-label="Daftar Booking" id="booking_list">
            {% for it in items %}
              {% if it.status == 'Confirmed' or it.status == 'confirmed' %}
              <article class="booking-card" aria-label="Booking">
                <div class="header-row">
                  <div class="ref">Ref: {{ it.ref }}</div>
                  <div class="status confirmed" aria-label="Status">Confirmed</div>
                </div>
                <div class="route">{{ it.origin }} → {{ it.destination }} <span class="meta">({{ it.airline }} {{ it.flight_number }})</span></div>
                <div class="meta">{{ it.departure_time }} - {{ it.arrival_time }}</div>
                {% if it.price %}
                  <div class="price">Total: {{ it.price }} {{ it.currency }}{% if it.price_idr_str %} • Rp {{ it.price_idr_str }}{% endif %}</div>
                {% endif %}
                <div class="card-actions">
                  <button class="sb-button-2 manage" type="button" data-idx="{{ forloop.counter0 }}" data-ref="{{ it.ref }}" data-airline="{{ it.airline }}" data-flight="{{ it.flight_number }}" data-origin="{{ it.origin }}" data-destination="{{ it.destination }}" data-departure="{{ it.departure_time }}" data-arrival="{{ it.arrival_time }}" data-amount="{{ it.price }}" data-currency="{{ it.currency }}" data-amount-idr="{{ it.price_idr_str|default:'' }}" data-passenger="{{ it.passenger_summary|default:'' }}" aria-label="Receipt Details for {{ it.ref }}" aria-expanded="false" aria-controls="receipt_details_{{ forloop.counter0 }}"><i class="bi bi-receipt" aria-hidden="true"></i><span>Receipt Details</span></button>
                </div>
                <div id="receipt_details_{{ forloop.counter0 }}" class="receipt-details" aria-hidden="true"></div>
              </article>
              {% endif %}
            {% endfor %}
          </section>
        {% else %}
          <section aria-label="Tidak ada booking">
            <article class="booking-card">
              <div class="header-row">
                <div class="ref">Tidak ada booking</div>
              </div>
              <div class="meta">Anda belum memiliki riwayat pemesanan.</div>
              {% if not confirmation %}
              <div class="card-actions">
                <a href="{% url 'search_flights' %}" class="sb-button">Mulai Cari</a>
              </div>
              {% endif %}
            </article>
          </section>
        {% endif %}
      {% endif %}
    </div>
  </main>
</body>
<script>
  (function(){
    const f = document.getElementById('booking_form');
    if(!f) return;
    function showError(msg){
      const c = document.querySelector('.container');
      let err = document.querySelector('.container .error');
      if(!err){ err = document.createElement('div'); err.className='error'; err.setAttribute('role','alert'); c.insertBefore(err, c.firstChild); }
      err.textContent = msg;
    }
    function clearError(){ const err = document.querySelector('.container .error'); if(err){ err.textContent=''; } }
    f.addEventListener('submit', function(e){
      clearError();
      const name = document.getElementById('name');
      const passport = document.getElementById('passport');
      const nationality = document.getElementById('nationality');
      const birth = document.getElementById('birth_date');
      const expiry = document.getElementById('passport_expiry');
      const email = document.getElementById('email');
      const phone = document.getElementById('phone');
      const errs = [];
      function markBad(el){ el.style.borderColor = '#dc2626'; }
      function markOk(el){ el.style.borderColor = 'var(--border)'; }
      [name, passport, nationality, birth, expiry, email, phone].forEach(markOk);
      if(!name.value.trim()){ errs.push('Nama Lengkap wajib diisi'); markBad(name); }
      if(!passport.value.trim()){ errs.push('Nomor Paspor wajib diisi'); markBad(passport); }
      if(!nationality.value.trim()){ errs.push('Nationality wajib dipilih'); markBad(nationality); }
      function validDate(el){ return !!el.value; }
      if(!validDate(birth)){ errs.push('Tanggal Lahir wajib diisi'); markBad(birth); }
      if(!validDate(expiry)){ errs.push('Masa Berlaku Paspor wajib diisi'); markBad(expiry); }
      const em = email.value.trim();
      if(!em || !em.includes('@')){ errs.push('Email tidak valid'); markBad(email); }
      const ph = phone.value.trim().replace(/\D/g,'');
      if(ph.length < 8){ errs.push('No. HP tidak valid'); markBad(phone); }
      if(errs.length){ e.preventDefault(); showError(errs[0]); }
    });
  })();
  (function(){
    const btns = document.querySelectorAll('.sb-button-2.manage');
    if(!btns || btns.length === 0){ try { console.warn('Receipt Details button not found'); } catch(e){} return; }
    function safe(t){ return (t||'').toString(); }
    async function fetchPassenger(ref){
      const endpoints = ['{% url "receipt_api" %}','/api/receipt','/receipt','/payments/receipt'];
      for(const ep of endpoints){
        try{
          const u = ep + (ep.includes('?') ? '&' : '?') + 'ref=' + encodeURIComponent(ref);
          const r = await fetch(u, { headers: { 'Accept':'application/json','X-Requested-With':'XMLHttpRequest' }, credentials: 'include' });
          if(!r.ok) continue;
          const ct = r.headers.get('content-type')||'';
          const data = ct.includes('json') ? await r.json() : JSON.parse(await r.text());
          const p = data.passenger || data.customer || (Array.isArray(data.passengers) && data.passengers[0]) || null;
          if(p){
            const name = p.full_name || p.name || p.display || '';
            const email = p.email || '';
            const passport = p.passport_number || p.passport || '';
            return [name, email, passport].filter(Boolean).join(' • ');
          }
        }catch(_){ continue; }
      }
      return '';
    }
    function buildContent(b){
      const ref = safe(b.getAttribute('data-ref'));
      const airline = safe(b.getAttribute('data-airline'));
      const flight = safe(b.getAttribute('data-flight'));
      const origin = safe(b.getAttribute('data-origin'));
      const destination = safe(b.getAttribute('data-destination'));
      const dep = safe(b.getAttribute('data-departure'));
      const arr = safe(b.getAttribute('data-arrival'));
      const amount = safe(b.getAttribute('data-amount'));
      const currency = safe(b.getAttribute('data-currency'));
      const idr = safe(b.getAttribute('data-amount-idr'));
      return { ref, airline, flight, origin, destination, dep, arr, amount, currency, idr };
    }
    function setExpanded(b, details, on){
      b.setAttribute('aria-expanded', on ? 'true' : 'false');
      details.setAttribute('aria-hidden', on ? 'false' : 'true');
      const icon = b.querySelector('i');
      const text = b.querySelector('span');
      if(icon){ icon.className = on ? 'bi bi-chevron-up' : 'bi bi-receipt'; icon.setAttribute('aria-hidden','true'); }
      if(text){ text.textContent = on ? 'Hide Details' : 'Receipt Details'; }
    }
    btns.forEach(function(b){
      const id = b.getAttribute('aria-controls');
      const details = id ? document.getElementById(id) : null;
      if(!details) return;
      const stateKey = 'receipt_open_' + safe(b.getAttribute('data-ref'));
      const saved = localStorage.getItem(stateKey);
      if(saved === '1'){ details.classList.add('open'); setExpanded(b, details, true); }
      b.addEventListener('click', async function(){
        try{
          const open = details.classList.contains('open');
          if(open){ details.classList.remove('open'); setExpanded(b, details, false); localStorage.setItem(stateKey, '0'); return; }
          const c = buildContent(b);
          details.innerHTML = '<div class="receipt-grid">'
            + '<div><div class="meta">Booking Reference</div><div class="ref" style="margin-top:4px;">' + c.ref + '</div></div>'
            + '<div><div class="meta">Flight</div><div style="margin-top:4px; font-weight:600;">' + c.airline + ' ' + c.flight + ' • ' + c.origin + ' → ' + c.destination + '</div><div class="meta" style="margin-top:4px;">' + c.dep + ' - ' + c.arr + '</div></div>'
            + '<div><div class="meta">Passenger</div><div id="rd_pass_' + id + '" style="margin-top:4px;">' + (safe(b.getAttribute('data-passenger')) || 'Memuat...') + '</div></div>'
            + '<div><div class="meta">Payment</div><div style="margin-top:4px;">' + (c.amount ? (c.amount + ' ' + c.currency) : '') + (c.idr ? (' • Rp ' + c.idr) : '') + '</div></div>'
            + '</div>';
          details.classList.add('open');
          setExpanded(b, details, true);
          localStorage.setItem(stateKey, '1');
          const p = await fetchPassenger(c.ref);
          const pEl = document.getElementById('rd_pass_' + id);
          if(pEl){ pEl.textContent = p || 'Data penumpang tidak tersedia'; }
        }catch(e){ try { console.error('Toggle receipt failed', e); } catch(_){} }
      });
    });
  })();
</script>
<script>
  (function(){
    var list = document.getElementById('booking_list');
    if(!list) return;
    var url = '{% url "my_bookings" %}';
    var timer = null;
    function refresh(){
      fetch(url, { credentials: 'include' })
        .then(function(r){ return r.text(); })
        .then(function(html){
          var doc = new DOMParser().parseFromString(html, 'text/html');
          var nl = doc.getElementById('booking_list');
          if(nl){ list.innerHTML = nl.innerHTML; }
        }).catch(function(){ /* ignore */ });
    }
    timer = setInterval(refresh, 10000);
    document.addEventListener('visibilitychange', function(){ if(document.hidden){ clearInterval(timer); timer = null; } else { if(!timer){ timer = setInterval(refresh, 10000); refresh(); } } });
  })();
</script>
</html>
